<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedestrian Signals</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100%; height:100%; }

.signalBox {
  text-align:center;
  font-family:sans-serif;
}

.signal {
  width:40px;
  height:40px;
  border-radius:50%;
  margin:2px auto;
  background:#300;
}

.gaugeWrap{
  width:40px;
  height:6px;
  background:#222;
  margin:2px auto;
  position:relative;
}

.gauge{
  height:100%;
  width:100%;
}

.timeText{
  font-size:10px;
  color:white;
}

.blink{
  animation: blink 1s infinite;
}

@keyframes blink{
  0%{opacity:1;}
  50%{opacity:0;}
  100%{opacity:1;}
}
</style>
</head>
<body>
<div id="map"></div>

<script>
const map = L.map('map',{
  zoomControl:true,
  touchZoom:true,
  scrollWheelZoom:true,
  doubleClickZoom:true,
  dragging:true
}).setView([36.07,140.13],14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

const intersections = {
  a:{lat:36.081246,lng:140.115064,cycle:[34,19,61,26],start:[7,23,58]},
  c:{lat:36.076570,lng:140.123876,cycle:[76,19,21,24],start:[7,30,0]},
  f:{lat:36.067278,lng:140.132438,cycle:[80,19,31,8],start:[7,34,35]},
  h:{lat:36.060625,lng:140.141941,cycle:[79,17,36,8],start:[7,39,54]}
};

function getState(data){
  const now=new Date();
  const start=new Date();
  start.setHours(data.start[0]);
  start.setMinutes(data.start[1]);
  start.setSeconds(data.start[2]);
  start.setMilliseconds(0);

  const elapsed=Math.floor((now-start)/1000);
  const total=data.cycle.reduce((a,b)=>a+b,0);
  const t=((elapsed%total)+total)%total;

  if(t<data.cycle[0]) return {type:"縦",remain:data.cycle[0]-t};
  if(t<data.cycle[0]+data.cycle[1]) return {type:"間",remain:data.cycle[0]+data.cycle[1]-t};
  if(t<data.cycle[0]+data.cycle[1]+data.cycle[2])
    return {type:"横",remain:data.cycle[0]+data.cycle[1]+data.cycle[2]-t};
  return {type:"間",remain:total-t};
}

function createSignalHTML(state,zoom){
  const scale=zoom*2;
  const size=scale;

  let color="red";
  let blinkClass="";
  if(state.type==="縦"||state.type==="横"){
    color="lime";
    if(state.remain<=5) blinkClass="blink";
  }

  return `
  <div class="signalBox" style="transform:scale(${size/20}) rotate(45deg);">
    <div class="gaugeWrap">
      <div class="gauge" style="background:${color};width:${(state.remain/100)*100}%"></div>
    </div>
    <div class="timeText">${state.remain}s</div>
    <div class="signal ${blinkClass}" style="background:${color};"></div>
  </div>
  `;
}

const markers={};

for(const key in intersections){
  const d=intersections[key];
  const state=getState(d);

  const icon=L.divIcon({
    html:createSignalHTML(state,map.getZoom()),
    className:'',
    iconSize:null
  });

  const marker=L.marker([d.lat,d.lng],{icon}).addTo(map);
  markers[key]=marker;
}

function update(){
  for(const key in intersections){
    const d=intersections[key];
    const state=getState(d);

    markers[key].setIcon(L.divIcon({
      html:createSignalHTML(state,map.getZoom()),
      className:'',
      iconSize:null
    }));
  }
}

setInterval(update,1000);

map.on("zoomend",update);
</script>
</body>
</html>
