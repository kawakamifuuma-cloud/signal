<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=10.0, user-scalable=yes">
<title>Pedestrian Signal Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
  margin: 0;
  height: 100%;
}

#map {
  width: 100%;
  height: 100%;
}

.signal-wrapper {
  position: relative;
  width: 40px;
  height: 100px;
  transform-origin: center;
}

.signal-box {
  width: 100%;
  height: 100%;
  background: #222;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  align-items: center;
  padding: 5px 0;
}

.light {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background: #111;
}

.red { background: red; }
.green { background: #00ff00; }

.blink {
  animation: blink 1s infinite;
}

@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.2; }
  100% { opacity: 1; }
}

.gauge {
  position: absolute;
  top: -12px;
  left: 0;
  height: 6px;
  background: red;
}

.timer {
  position: absolute;
  top: -28px;
  width: 100%;
  text-align: center;
  font-size: 10px;
  color: black;
  font-weight: bold;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
const map = L.map('map').setView([36.081246, 140.115064], 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

const intersections = {
  a: { lat:36.081246, lng:140.115064, cycle:[34,19,61,26], total:140, sync:"07:23:58"},
  c: { lat:36.076570, lng:140.123876, cycle:[76,19,21,24], total:140, sync:"07:30:00"},
  f: { lat:36.067278, lng:140.132438, cycle:[80,19,31,8], total:138, sync:"07:34:35"},
  h: { lat:36.060625, lng:140.141941, cycle:[79,17,36,8], total:140, sync:"07:39:54"}
};

function secondsSinceSync(syncTime){
  const now = new Date();
  const [h,m,s] = syncTime.split(":").map(Number);
  const sync = new Date();
  sync.setHours(h,m,s,0);
  return Math.floor((now - sync)/1000);
}

function createSignal(intersection){
  const div = document.createElement("div");
  div.className = "signal-wrapper";

  const box = document.createElement("div");
  box.className = "signal-box";

  const red = document.createElement("div");
  red.className = "light";

  const green = document.createElement("div");
  green.className = "light";

  box.appendChild(red);
  box.appendChild(green);
  div.appendChild(box);

  const gauge = document.createElement("div");
  gauge.className = "gauge";
  div.appendChild(gauge);

  const timer = document.createElement("div");
  timer.className = "timer";
  div.appendChild(timer);

  const marker = L.marker([intersection.lat, intersection.lng], {
    icon: L.divIcon({className:"", html:div})
  }).addTo(map);

  function update(){
    const elapsed = secondsSinceSync(intersection.sync) % intersection.total;
    const [vertical, interval1, horizontal, interval2] = intersection.cycle;

    let phase, remain, duration;

    if(elapsed < vertical){
      phase="vertical";
      duration=vertical;
      remain=vertical-elapsed;
    } else if(elapsed < vertical+interval1){
      phase="interval";
      duration=interval1;
      remain=vertical+interval1-elapsed;
    } else if(elapsed < vertical+interval1+horizontal){
      phase="horizontal";
      duration=horizontal;
      remain=vertical+interval1+horizontal-elapsed;
    } else {
      phase="interval";
      duration=interval2;
      remain=intersection.total-elapsed;
    }

    red.classList.remove("red");
    green.classList.remove("green","blink");

    if(phase==="vertical" || phase==="horizontal"){
      green.classList.add("green");
      if(remain<=5){
        green.classList.add("blink");
      }
      gauge.style.background="green";
    } else {
      red.classList.add("red");
      gauge.style.background="red";
    }

    gauge.style.width = (remain/duration*100)+"%";
    timer.textContent = remain+"s";
  }

  setInterval(update,1000);
  update();

  map.on("zoom", ()=>{
    const scale = map.getZoom()/15;
    div.style.transform = "scale("+scale+") rotate(45deg)";
  });
}

for(const key in intersections){
  createSignal(intersections[key]);
}
</script>

</body>
</html>
